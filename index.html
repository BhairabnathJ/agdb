<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriScan Dashboard</title>
    <link rel="stylesheet" href="/css/main.css">
    <script src="/js/physics.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="/js/app.js"></script>

</head>

<body>

    <main class="container">

        <!-- Home -->
        <section id="tier-1" class="view-section active">
            <!-- Status Icon -->
            <div class="status-hero">
                <div id="t1-status-icon" class="status-circle-large healthy"></div>
            </div>

            <!-- Primary Message -->
            <p id="t1-greeting" class="hero-kicker">Good afternoon üëã</p>
            <h1 id="t1-message" class="hero-title">Your field is looking healthy today.</h1>
            <p id="t1-instruction" class="hero-subtitle">Soil moisture is at good levels across your active zones.</p>

            <!-- Actions -->
            <div class="hero-actions">
                <button class="btn-primary btn-large" onclick="App.navigate('homeInsights')">Quick View</button>
                <button class="btn-secondary btn-large" onclick="App.navigate('history')">Field Details</button>
            </div>

            <div class="hero-glance">
                <div class="glance-row">
                    <span>üíß Moisture</span>
                    <strong id="t1-glance-moisture">Optimal</strong>
                </div>
                <div class="glance-row">
                    <span>üå° Temperature</span>
                    <strong id="t1-glance-temp">--¬∞C</strong>
                </div>
                <div class="glance-row">
                    <span>üìç Active Sensors</span>
                    <strong id="t1-glance-zones">--</strong>
                </div>
                <div class="glance-row">
                    <span>‚è∞ Last Checked</span>
                    <strong id="t1-time">Just now</strong>
                </div>
            </div>

            <div class="hero-footer">
                <span id="t1-footer-note">Updates every few minutes</span>
                <div style="margin-top:20px;">
                    <!-- Feature #7: Language Selector -->
                    <select id="lang-select-t1"
                        style="font-size:12px; padding:4px; border:1px solid #ccc; border-radius:4px;"
                        onchange="App.setLang(this.value)">
                        <option value="en">English</option>
                        <option value="es">Espa√±ol</option>
                    </select>
                </div>
            </div>
        </section>


        <!-- Home Insights -->
        <section id="tier-2" class="view-section">
            <div class="view-header">
                <h2 class="font-h2">Today's Field Insight</h2>
            </div>

            <div class="reasoning-card">
                <ul class="reasoning-list" id="t2-reasons">
                    <!-- JS Populated -->
                </ul>
            </div>

            <div class="action-stack">
                <button class="btn-primary btn-full" onclick="App.navigate('home')">Back to Home</button>
                <button class="btn-ghost btn-full" onclick="App.navigate('history')">Open History</button>
            </div>
        </section>


        <!-- History -->
        <section id="tier-3" class="view-section">
            <div class="view-header">
                <button class="btn-text" onclick="App.navigate('home')">‚Äπ Back to Home</button>
            </div>

            <!-- Current Readings Grid (Updated for VWC/Psi) -->
            <div class="metrics-grid-dense">
                <div class="metric-cell healthy" id="t3-moist-cell">
                    <label>Soil Moisture</label>
                    <span id="t3-moist">--%</span>
                </div>
                <div class="metric-cell" id="t3-soil-temp-cell">
                    <label>Soil Temperature</label>
                    <span id="t3-soil-temp">--¬∞C</span>
                </div>
                <div class="metric-cell">
                    <label>Sensor Confidence</label>
                    <span id="t3-confidence">--%</span>
                </div>
                <div class="metric-cell">
                    <label>Water Pressure</label>
                    <span id="t3-vpd">--</span>
                </div>
                <div class="metric-cell">
                    <label>Available Water</label>
                    <span id="t3-leaf">--</span>
                </div>
                <div class="metric-cell">
                    <label>Water Used</label>
                    <span id="t3-depletion">--</span>
                </div>
            </div>

            <!-- Chart -->
            <div class="chart-wrapper">
                <h3 class="font-h3">Moisture Trend</h3>
                <p id="chart-trend" style="margin:0 0 10px; color:var(--neutral-600); font-size:0.9rem;">Trend: --</p>
                <div class="chart-container" id="tier3-chart">
                    <!-- SVG Chart -->
                </div>
            </div>

            <div class="metrics-grid-dense">
                <div class="metric-cell" id="decision-panel">
                    <label>Watering Decision</label>
                    <span id="decision-need">Should I water today? --</span>
                    <small id="decision-next">Next watering window: --</small>
                </div>
                <div class="metric-cell" id="health-panel">
                    <label>Field Health</label>
                    <span id="health-status">Overall status: --</span>
                    <small id="health-zone">Zones needing attention: --</small>
                </div>
            </div>

            <!-- Actions -->
            <div class="action-grid">
                <button class="btn-secondary" onclick="App.navigate('map')">View Field Map</button>
                <button class="btn-secondary" onclick="App.exportCSV()">Download DB</button>
            </div>
            <div class="action-grid" style="margin-top:8px;">
                <button class="btn-secondary" onclick="App.navigate('settings')">View Settings</button>
                <button class="btn-secondary" onclick="App.toggleDevMode()">Open Dev Tools</button>
            </div>

        </section>


        <!-- Field Map -->
        <section id="tier-map" class="view-section">
            <div class="view-header">
                <button class="btn-text" onclick="App.navigate('history')">‚Äπ Back</button>
                <h2 class="font-h2">Field Zones</h2>
            </div>

            <div class="zone-legend">
                <p style="font-size:14px; color:var(--neutral-600); margin-bottom:16px;">
                    Select a field section to view detailed sensor data. Gray sections have no sensor.
                </p>
                <button class="btn-secondary" onclick="App.toggleProblemFirst()">Problem zones first: <span id="problem-first-state">Off</span></button>
                <div class="legend-items">
                    <div class="legend-item">
                        <span class="legend-color" style="background:var(--status-healthy);"></span>
                        <span>Healthy</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background:var(--status-warning);"></span>
                        <span>Warning</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background:var(--status-critical);"></span>
                        <span>Critical</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background:var(--neutral-300);"></span>
                        <span>No Sensor</span>
                    </div>
                </div>
            </div>

            <!-- Zone Grid (4x4, 9 active sensors) -->
            <div id="zone-grid" class="zone-grid">
                <!-- Populated by App.renderZoneGrid() -->
            </div>

            <!-- Selected Zone Details -->
            <div id="zone-details" class="zone-details" style="display:none;">
                <h3 class="font-h3" style="margin-bottom:12px;">Field Section: <span id="zone-name">--</span></h3>
                <div class="metrics-grid-dense">
                    <div class="metric-cell">
                        <label>VWC</label>
                        <span id="zone-vwc">--%</span>
                    </div>
                    <div class="metric-cell">
                        <label>Potential</label>
                        <span id="zone-psi">--kPa</span>
                    </div>
                    <div class="metric-cell">
                        <label>Avail H2O</label>
                        <span id="zone-aw">--mm</span>
                    </div>
                    <div class="metric-cell">
                        <label>Depletion</label>
                        <span id="zone-depl">--%</span>
                    </div>
                    <div class="metric-cell">
                        <label>Status</label>
                        <span id="zone-status">--</span>
                    </div>
                    <div class="metric-cell">
                        <label>Regime</label>
                        <span id="zone-regime">--</span>
                    </div>
                </div>
                <button class="btn-secondary btn-full" style="margin-top:16px;" onclick="App.clearZoneSelection()">Clear
                    Selection</button>
            </div>

            <div class="action-grid" style="margin-top:24px;">
                <button class="btn-secondary" onclick="App.navigate('history')">Back to Dashboard</button>
            </div>
        </section>


        <!-- SETTINGS INFO -->
        <section id="settings" class="view-section">
            <div class="view-header">
                <button class="btn-text" onclick="App.navigate('history')">‚Äπ Back</button>
                <h2 class="font-h2">Settings</h2>
            </div>

            <div class="settings-tabs">
                <button class="settings-tab active" data-settings-tab="field" onclick="App.openSettingsTab('field')">Field Setup</button>
                <button class="settings-tab" data-settings-tab="prefs" onclick="App.openSettingsTab('prefs')">Preferences</button>
                <button class="settings-tab" data-settings-tab="device" onclick="App.openSettingsTab('device')">Device Info</button>
            </div>

            <div class="settings-panel active" data-settings-panel="field">
                <div class="settings-group">
                    <h3 class="font-h3">Field Setup</h3>
                    <label class="settings-label">Crop Type</label>
                    <select class="form-select" id="set-crop">
                        <option value="tomato">Tomato</option>
                    </select>

                    <label class="settings-label" style="margin-top:12px;">Soil Type</label>
                    <select class="form-select" id="set-soil">
                        <option value="loam">Normal / Mixed</option>
                    </select>

                    <label class="settings-label" style="margin-top:12px;">Planting Date</label>
                    <input type="date" class="form-select" id="set-date">

                    <label class="settings-label" style="margin-top:12px;">Flow Rate (L/hr)</label>
                    <input type="number" class="form-select" id="set-flow" value="1000">

                    <label class="settings-label" style="margin-top:12px;">Farm Area (Hectares)</label>
                    <input type="number" class="form-select" id="set-area" value="2.5">
                </div>
            </div>

            <div class="settings-panel" data-settings-panel="prefs">
                <div class="settings-group">
                    <h3 class="font-h3">Preferences</h3>
                    <label class="settings-label">Language</label>
                    <select class="form-select" id="set-lang" onchange="App.setLang(this.value)">
                        <option value="en">English</option>
                        <option value="es">Espa√±ol</option>
                    </select>
                </div>

                <div class="settings-group">
                    <label class="settings-label">Temperature Unit</label>
                    <div class="toggle-group">
                        <button class="btn-full active" id="btn-c">¬∞C</button>
                        <button class="btn-full" id="btn-f">¬∞F</button>
                    </div>
                </div>
            </div>

            <div class="settings-panel" data-settings-panel="device">
                <div class="settings-group">
                    <label class="settings-label">Device Info</label>
                    <div class="info-box">
                        <p>Serial: AG-2026-X88</p>
                        <p>Firmware: v2.5.0</p>
                        <p>Storage: 45% used</p>
                        <p>Troubleshooting: press <strong>Ctrl+Shift+D</strong> for diagnostics and dev tools.</p>
                    </div>
                </div>
            </div>

            <button class="btn-primary btn-full" onclick="App.saveSettings()">Save Configuration</button>
        </section>

    </main>
    <div id="dev-indicator" class="dev-indicator">DEV MODE</div>
    <aside id="dev-panel" class="dev-panel" aria-label="Developer tools">
        <div class="view-header">
            <h2 class="font-h2">Developer Tools</h2>
            <button class="btn-secondary" onclick="App.toggleDevMode()">Close</button>
        </div>
        <div class="settings-group">
            <h3 class="font-h3">Simulation</h3>
            <div class="action-grid">
                <button class="btn-secondary" onclick="App.simulateRain()">Simulate Rain</button>
                <button class="btn-secondary" onclick="App.simulateDrought()">Simulate Drought</button>
            </div>
            <div class="action-grid" style="margin-top:12px;">
                <button class="btn-secondary" id="btn-long-run" onclick="App.simulateLongRun()">10-Min Simulation</button>
                <button class="btn-secondary" id="btn-stop-sim" onclick="App.stopSimulation()" disabled>Stop</button>
            </div>
            <div id="sim-countdown" class="sim-countdown" style="display:none;">
                <span id="sim-phase">--</span> | <span id="sim-time">00:00</span>
            </div>
        </div>
        <div class="settings-group">
            <h3 class="font-h3">Diagnostics & Exports</h3>
            <div class="action-grid">
                <button class="btn-secondary" onclick="App.exportSimulationLogs()">Export Logs (JSON)</button>
                <button class="btn-secondary" onclick="App.exportAllData()">Export Full Data</button>
            </div>
            <div class="action-grid" style="margin-top:12px;">
                <button class="btn-secondary" onclick="App.goToDiagnostics()">System Diagnostics</button>
                <button class="btn-secondary" onclick="App.resetSimulationState()">Reset Simulation</button>
            </div>
        </div>
    </aside>
    <nav class="bottom-nav" aria-label="Primary">
        <button id="nav-home" class="nav-item active" onclick="App.navigate('home')">Home</button>
        <button id="nav-map" class="nav-item" onclick="App.navigate('map')">Field Map</button>
        <button id="nav-history" class="nav-item" onclick="App.navigate('history')">History</button>
        <button id="nav-settings" class="nav-item" onclick="App.navigate('settings')">Settings</button>
    </nav>

    <script src="js/physics.js"></script>
    <script src="js/i18n.js"></script>
    <script>
        (function () {
            try {
                const primary = localStorage.getItem('agriscan_user_prefs');
                const legacy = localStorage.getItem('agriscan_settings');
                const config = primary ? JSON.parse(primary) : (legacy ? JSON.parse(legacy) : null);
                if (config && config.onboarding_complete) {
                    if (!primary) {
                        localStorage.setItem('agriscan_user_prefs', JSON.stringify(config));
                    }
                    return;
                }
                window.location.href = '/onboarding.html';
            } catch (e) {
                console.error('Onboarding check error:', e);
                window.location.href = '/onboarding.html';
            }
        })();
    </script>

    <script src="js/app.js"></script>
</body>

</html>
