/**
 * I18n System
 * Simple translation handler with full logging.
 */

const I18n = {
    lang: 'en',

    strings: {
        en: {
            // Static UI
            "quick_view": "Quick View",
            "field_details": "Field Details",
            "glance_moisture": "ðŸ’§ Moisture",
            "glance_temperature": "ðŸŒ¡ Temperature",
            "glance_active_sensors": "ðŸ“ Active Sensors",
            "glance_last_checked": "â° Last Checked",
            "updates_every_few_minutes": "Updates every few minutes",
            "todays_field_insight": "Today's Field Insight",
            "back_to_home": "â€¹ Back to Home",
            "open_history": "Open History",
            "soil_moisture": "Soil Moisture",
            "soil_temperature": "Soil Temperature",
            "available_water": "Available Water",
            "metric_moisture": "ðŸ’§ Moisture",
            "metric_temp": "ðŸŒ¡ï¸ Temp",
            "metric_water": "ðŸ’¦ Water",
            "time_range": "Time Range",
            "last_24_hours": "Last 24 hours",
            "last_7_days": "Last 7 days",
            "last_30_days": "Last 30 days",
            "watering_decision": "Watering Decision",
            "field_health": "Field Health",
            "plant_water_access": "Plant Water Access",
            "sensor_confidence": "Sensor Confidence",
            "water_used": "Water Used",
            "view_field_map": "View Field Map",
            "download_db": "Download DB",
            "view_settings": "View Settings",
            "open_dev_tools": "Open Dev Tools",
            "back": "â€¹ Back",
            "field_zones": "Field Zones",
            "map_help": "Select a field section to view detailed sensor data. Gray sections have no sensor.",
            "problem_zones_first": "Problem zones first",
            "healthy": "Healthy",
            "warning": "Warning",
            "critical": "Critical",
            "no_sensor": "No Sensor",
            "field_section": "Field Section",
            "zone_trend_24h": "Zone Trend (Last 24h)",
            "clear_selection": "Clear Selection",
            "back_to_dashboard": "Back to Dashboard",
            "settings": "Settings",
            "field_setup": "Field Setup",
            "preferences": "Preferences",
            "device_info": "Device Info",
            "crop_type": "Crop Type",
            "soil_type": "Soil Type",
            "planting_date": "Planting Date",
            "flow_rate": "Flow Rate (L/hr)",
            "farm_area": "Farm Area (Hectares)",
            "language": "Language",
            "temperature_unit": "Temperature Unit",
            "save_configuration": "Save Configuration",
            "dev_mode": "DEV MODE",
            "developer_tools": "Developer Tools",
            "close": "Close",
            "simulation": "Simulation",
            "simulate_rain": "Simulate Rain",
            "simulate_drought": "Simulate Drought",
            "simulation_10m": "10-Min Simulation",
            "stop": "Stop",
            "diagnostics_exports": "Diagnostics & Exports",
            "export_logs_json": "Export Logs (JSON)",
            "export_full_data": "Export Full Data",
            "system_diagnostics": "System Diagnostics",
            "reset_simulation": "Reset Simulation",
            "nav_home": "Home",
            "nav_field_map": "Field Map",
            "nav_history": "History",
            "nav_settings": "Settings",
            "device_serial": "Serial: AG-2026-X88",
            "device_firmware": "Firmware: v2.5.0",
            "device_storage": "Storage: 45% used",
            "device_troubleshooting": "Troubleshooting: press Ctrl+Shift+D for diagnostics and dev tools.",
            "zone_vwc": "VWC",
            "zone_potential": "Potential",
            "zone_avail_h2o": "Avail H2O",
            "zone_depletion": "Depletion",
            "zone_status": "Status",
            "zone_regime": "Regime",
            "chart_title_moisture": "Soil Moisture Trend",
            "chart_title_aw": "Available Water Trend",
            "chart_title_depletion": "Water Used Trend",
            "chart_title_temp": "Soil Temperature Trend",

            // Dynamic UI
            "greeting_morning": "Good morning",
            "greeting_afternoon": "Good afternoon",
            "greeting_evening": "Good evening",
            "weather_hot": "â˜€ï¸ Hot and dry today",
            "weather_cool": "â›… Cool conditions",
            "weather_mild": "ðŸŒ¤ Mild field conditions",
            "home_msg_critical": "Your field needs watering attention today.",
            "home_msg_warning": "Your field is stable, but a few areas are drying.",
            "home_msg_healthy": "Your field is looking healthy today.",
            "home_msg_no_healthy": "Your field has no healthy zones right now.",
            "home_instr_critical": "Critical moisture detected. {action}.",
            "home_instr_warning": "{action}.",
            "home_instr_healthy": "Soil moisture is at good levels across your active zones.",
            "home_instr_no_healthy": "Open Field Details to see which zones need attention first.",
            "updated_just_now": "Updated just now",
            "updated_min_ago": "Updated {mins} min ago",
            "sensors_count": "{count} sensors",
            "collecting_data_from_zones": "Collecting data from {count} zones",
            "reporting_zones_healthy": "{healthy} of {count} reporting zones healthy",
            "tier2_title_high": "Watering needs your attention today",
            "tier2_title_medium": "Field check recommended soon",
            "tier2_title_low": "Why your field is in good shape",
            "tier2_moisture_reason": "Soil moisture is {moisture}% (ideal around {ideal}%).",
            "tier2_crop_stress": "Crop stress risk is elevated for {crop} ({stage} stage).",
            "tier2_crop_age": "Crop age: {days} days after planting.",
            "tier2_water_trend": "Water trend: {trend}",
            "still_learning": "still learning",
            "tier2_model_confidence": "Model confidence: {confidence}%.",
            "status_critical_short": "CRITICAL",
            "status_watch_short": "WATCH",
            "status_healthy_short": "HEALTHY",
            "action_water_12h": "Water within 12 hours",
            "action_check_hours": "Check again in {hours} hours",
            "action_no_water_today": "No watering needed today",
            "decision_yes_soon": "Yes, water soon",
            "decision_prepare_soon": "Not now, prepare soon",
            "decision_no_today": "No, not today",
            "decision_detail_critical": "Moisture is below safe target. Prioritize irrigation now.",
            "decision_detail_warning": "Moisture is near the lower target. Plan watering within {hours} hours.",
            "decision_detail_healthy": "Moisture is in a healthy range. Continue monitoring.",
            "t3_target_status": "Target: {low}-{high}% Â· Status: {status}",
            "t3_crop_comfort_heat": "Crop comfort: heat stress risk",
            "t3_crop_comfort_cool": "Crop comfort: cool stress risk",
            "t3_crop_comfort_good": "Crop comfort: good",
            "t3_accuracy_good": "Good accuracy Â· no issues",
            "t3_accuracy_moderate": "Moderate accuracy Â· still learning",
            "t3_roots_reach_yes": "Roots can reach water: Yes",
            "t3_roots_reach_limited": "Roots can reach water: Limited",
            "t3_target_reserve": "Target reserve: {value}+ mm",
            "t3_since_refill": "Since last refill: {value}%",
            "decision_need_line": "Should I water today? {decision}",
            "decision_next_line": "{detail} Next watering: within {hours}h.",
            "health_status_line": "Overall status: {status}",
            "health_zones_line": "Zones needing attention: {count}",
            "status_critical_needs_water": "CRITICAL - needs water soon",
            "status_watch_monitor": "WATCH - monitor",
            "status_healthy_word": "HEALTHY",
            "trend_stable": "Trend: â†’ Stable",
            "trend_increasing": "Trend: â†— Increasing",
            "trend_dropping": "Trend: â†˜ Dropping quickly",
            "currently_with_status": "Currently {value}{unit} ({status})",
            "vs_yesterday": "vs Yesterday {value}{unit}",
            "forecast_plus_2h": "Forecast +2h {value}{unit}",
            "chart_not_enough_data_range": "Not enough data for this time range yet.",
            "chart_keep_running": "Keep the app running to build trend history.",
            "chart_try_longer": "Try a longer range if available.",
            "chart_field_average_only": "This chart uses field-average values only.",
            "chart_need_more_samples": "Need more samples to draw a smooth average trend.",
            "chart_temp_stable_no_graph": "Temperature is stable ({min}-{max}Â°C). No trend graph needed right now.",
            "chart_temp_tight_range": "Temperature stayed within a tight range today.",
            "chart_no_thermal_stress": "No thermal stress event detected.",
            "chart_graph_hidden_noise": "Graph hidden to reduce noise.",
            "chart_current_line": "Currently: {value}{unit} ({status})",
            "chart_peak_low_line": "Peak: {peak}{unit} Â· Low: {low}{unit}",
            "chart_forecast_line": "Forecast: {value}{unit} in ~2h Â· field average",
            "zone_waiting_data": "Waiting for more sensor data...",
            "zone_trend_after_readings": "Trend will appear after a few readings.",
            "zone_current_trend": "Current {value}% moisture Â· Trend: {trend}",
            "zone_trend_rising": "rising",
            "zone_trend_drying": "drying",
            "zone_trend_stable": "stable",
            "problem_first_on": "On",
            "problem_first_off": "Off",

            // Tier 1 Status
            "status_irrigate": "WATER YOUR CROPS",
            "status_check": "CHECK FIELD SOON",
            "status_good": "ALL GOOD",
            "action_irrigate": "Open valve for {hours} hours",
            "action_check": "Moisture is dropping",
            "action_good": "No action needed",
            // Tier 2 Reasoning
            "why_title_irrigate": "Why do I need to water?",
            "why_title_check": "Why should I check the field?",
            "why_title_good": "Why is everything good?",
            "reason_moisture_low": "Moisture is {moisture}% (Target: >{critical}%)",
            "reason_drying_fast": "Drying rate is high ({rate}%/hr)",
            "reason_stress": "Crop stress begins in {hours} hours",
            "reason_optimal": "Soil moisture is in the optimal range",
            "reason_stable": "Conditions are stable, no action needed",
            // Zone Map
            "zone_title": "Field Zones",
            "zone_active": "{count} sensors active",
            "zone_legend_optimal": "Optimal",
            "zone_legend_warning": "Warning",
            "zone_legend_critical": "Critical",
            // General
            "updated": "Updated: {time}",
            "confidence": "Confidence: {value}%"
        },
        es: {
            // Static UI
            "quick_view": "Vista rÃ¡pida",
            "field_details": "Detalles del campo",
            "glance_moisture": "ðŸ’§ Humedad",
            "glance_temperature": "ðŸŒ¡ Temperatura",
            "glance_active_sensors": "ðŸ“ Sensores activos",
            "glance_last_checked": "â° Ãšltima revisiÃ³n",
            "updates_every_few_minutes": "Actualiza cada pocos minutos",
            "todays_field_insight": "Resumen del campo de hoy",
            "back_to_home": "â€¹ Volver al inicio",
            "open_history": "Abrir historial",
            "soil_moisture": "Humedad del suelo",
            "soil_temperature": "Temperatura del suelo",
            "available_water": "Agua disponible",
            "metric_moisture": "ðŸ’§ Humedad",
            "metric_temp": "ðŸŒ¡ï¸ Temp",
            "metric_water": "ðŸ’¦ Agua",
            "time_range": "Rango de tiempo",
            "last_24_hours": "Ãšltimas 24 horas",
            "last_7_days": "Ãšltimos 7 dÃ­as",
            "last_30_days": "Ãšltimos 30 dÃ­as",
            "watering_decision": "DecisiÃ³n de riego",
            "field_health": "Estado del campo",
            "plant_water_access": "Acceso de agua para la planta",
            "sensor_confidence": "Confianza del sensor",
            "water_used": "Agua usada",
            "view_field_map": "Ver mapa del campo",
            "download_db": "Descargar BD",
            "view_settings": "Ver ajustes",
            "open_dev_tools": "Abrir herramientas dev",
            "back": "â€¹ Volver",
            "field_zones": "Zonas del campo",
            "map_help": "Selecciona una secciÃ³n para ver datos detallados del sensor. Las secciones grises no tienen sensor.",
            "problem_zones_first": "Zonas problemÃ¡ticas primero",
            "healthy": "Saludable",
            "warning": "Advertencia",
            "critical": "CrÃ­tico",
            "no_sensor": "Sin sensor",
            "field_section": "SecciÃ³n del campo",
            "zone_trend_24h": "Tendencia de zona (Ãºltimas 24h)",
            "clear_selection": "Limpiar selecciÃ³n",
            "back_to_dashboard": "Volver al panel",
            "settings": "Ajustes",
            "field_setup": "ConfiguraciÃ³n del campo",
            "preferences": "Preferencias",
            "device_info": "Info del dispositivo",
            "crop_type": "Tipo de cultivo",
            "soil_type": "Tipo de suelo",
            "planting_date": "Fecha de siembra",
            "flow_rate": "Caudal (L/h)",
            "farm_area": "Ãrea de la finca (hectÃ¡reas)",
            "language": "Idioma",
            "temperature_unit": "Unidad de temperatura",
            "save_configuration": "Guardar configuraciÃ³n",
            "dev_mode": "MODO DEV",
            "developer_tools": "Herramientas de desarrollo",
            "close": "Cerrar",
            "simulation": "SimulaciÃ³n",
            "simulate_rain": "Simular lluvia",
            "simulate_drought": "Simular sequÃ­a",
            "simulation_10m": "SimulaciÃ³n 10 min",
            "stop": "Detener",
            "diagnostics_exports": "DiagnÃ³sticos y exportaciones",
            "export_logs_json": "Exportar logs (JSON)",
            "export_full_data": "Exportar datos completos",
            "system_diagnostics": "DiagnÃ³stico del sistema",
            "reset_simulation": "Reiniciar simulaciÃ³n",
            "nav_home": "Inicio",
            "nav_field_map": "Mapa",
            "nav_history": "Historial",
            "nav_settings": "Ajustes",
            "device_serial": "Serie: AG-2026-X88",
            "device_firmware": "Firmware: v2.5.0",
            "device_storage": "Almacenamiento: 45% usado",
            "device_troubleshooting": "SoluciÃ³n de problemas: pulsa Ctrl+Shift+D para diagnÃ³sticos y herramientas dev.",
            "zone_vwc": "VWC",
            "zone_potential": "Potencial",
            "zone_avail_h2o": "Agua disp.",
            "zone_depletion": "DepleciÃ³n",
            "zone_status": "Estado",
            "zone_regime": "RÃ©gimen",
            "chart_title_moisture": "Tendencia de humedad del suelo",
            "chart_title_aw": "Tendencia de agua disponible",
            "chart_title_depletion": "Tendencia de agua usada",
            "chart_title_temp": "Tendencia de temperatura del suelo",

            // Dynamic UI
            "greeting_morning": "Buenos dÃ­as",
            "greeting_afternoon": "Buenas tardes",
            "greeting_evening": "Buenas noches",
            "weather_hot": "â˜€ï¸ Caluroso y seco hoy",
            "weather_cool": "â›… Condiciones frescas",
            "weather_mild": "ðŸŒ¤ Condiciones templadas",
            "home_msg_critical": "Tu campo necesita riego hoy.",
            "home_msg_warning": "Tu campo estÃ¡ estable, pero algunas zonas se estÃ¡n secando.",
            "home_msg_healthy": "Tu campo se ve saludable hoy.",
            "home_msg_no_healthy": "Tu campo no tiene zonas saludables en este momento.",
            "home_instr_critical": "Se detectÃ³ humedad crÃ­tica. {action}.",
            "home_instr_warning": "{action}.",
            "home_instr_healthy": "La humedad del suelo estÃ¡ en buen nivel en tus zonas activas.",
            "home_instr_no_healthy": "Abre Detalles del campo para ver quÃ© zonas requieren atenciÃ³n.",
            "updated_just_now": "Actualizado ahora mismo",
            "updated_min_ago": "Actualizado hace {mins} min",
            "sensors_count": "{count} sensores",
            "collecting_data_from_zones": "Recolectando datos de {count} zonas",
            "reporting_zones_healthy": "{healthy} de {count} zonas reportadas saludables",
            "tier2_title_high": "El riego necesita tu atenciÃ³n hoy",
            "tier2_title_medium": "Se recomienda revisar el campo pronto",
            "tier2_title_low": "Por quÃ© tu campo estÃ¡ en buen estado",
            "tier2_moisture_reason": "La humedad del suelo estÃ¡ en {moisture}% (ideal alrededor de {ideal}%).",
            "tier2_crop_stress": "El riesgo de estrÃ©s del cultivo es elevado para {crop} (etapa {stage}).",
            "tier2_crop_age": "Edad del cultivo: {days} dÃ­as desde la siembra.",
            "tier2_water_trend": "Tendencia del agua: {trend}",
            "still_learning": "aprendiendo",
            "tier2_model_confidence": "Confianza del modelo: {confidence}%.",
            "status_critical_short": "CRÃTICO",
            "status_watch_short": "VIGILAR",
            "status_healthy_short": "SALUDABLE",
            "action_water_12h": "Regar en 12 horas",
            "action_check_hours": "Revisar de nuevo en {hours} horas",
            "action_no_water_today": "No se necesita riego hoy",
            "decision_yes_soon": "SÃ­, regar pronto",
            "decision_prepare_soon": "AÃºn no, prepÃ¡rate pronto",
            "decision_no_today": "No, hoy no",
            "decision_detail_critical": "La humedad estÃ¡ por debajo del nivel seguro. Prioriza el riego ahora.",
            "decision_detail_warning": "La humedad estÃ¡ cerca del lÃ­mite inferior. Planifica riego en {hours} horas.",
            "decision_detail_healthy": "La humedad estÃ¡ en rango saludable. ContinÃºa monitoreando.",
            "t3_target_status": "Objetivo: {low}-{high}% Â· Estado: {status}",
            "t3_crop_comfort_heat": "Confort del cultivo: riesgo de calor",
            "t3_crop_comfort_cool": "Confort del cultivo: riesgo de frÃ­o",
            "t3_crop_comfort_good": "Confort del cultivo: bien",
            "t3_accuracy_good": "Buena precisiÃ³n Â· sin problemas",
            "t3_accuracy_moderate": "PrecisiÃ³n moderada Â· aÃºn aprendiendo",
            "t3_roots_reach_yes": "RaÃ­ces con acceso al agua: SÃ­",
            "t3_roots_reach_limited": "RaÃ­ces con acceso al agua: Limitado",
            "t3_target_reserve": "Reserva objetivo: {value}+ mm",
            "t3_since_refill": "Desde Ãºltima recarga: {value}%",
            "decision_need_line": "Â¿Debo regar hoy? {decision}",
            "decision_next_line": "{detail} PrÃ³ximo riego: en {hours}h.",
            "health_status_line": "Estado general: {status}",
            "health_zones_line": "Zonas que requieren atenciÃ³n: {count}",
            "status_critical_needs_water": "CRÃTICO - necesita riego pronto",
            "status_watch_monitor": "VIGILAR - monitorear",
            "status_healthy_word": "SALUDABLE",
            "trend_stable": "Tendencia: â†’ Estable",
            "trend_increasing": "Tendencia: â†— Aumentando",
            "trend_dropping": "Tendencia: â†˜ Bajando rÃ¡pido",
            "currently_with_status": "Actualmente {value}{unit} ({status})",
            "vs_yesterday": "vs ayer {value}{unit}",
            "forecast_plus_2h": "ProyecciÃ³n +2h {value}{unit}",
            "chart_not_enough_data_range": "AÃºn no hay suficientes datos para este rango.",
            "chart_keep_running": "Deja la app abierta para acumular historial.",
            "chart_try_longer": "Prueba un rango mÃ¡s largo si estÃ¡ disponible.",
            "chart_field_average_only": "Este grÃ¡fico usa solo promedio del campo.",
            "chart_need_more_samples": "Se necesitan mÃ¡s muestras para dibujar una tendencia suave.",
            "chart_temp_stable_no_graph": "La temperatura estÃ¡ estable ({min}-{max}Â°C). No hace falta grÃ¡fico ahora.",
            "chart_temp_tight_range": "La temperatura se mantuvo en un rango estrecho hoy.",
            "chart_no_thermal_stress": "No se detectÃ³ estrÃ©s tÃ©rmico.",
            "chart_graph_hidden_noise": "GrÃ¡fico oculto para reducir ruido.",
            "chart_current_line": "Actual: {value}{unit} ({status})",
            "chart_peak_low_line": "Pico: {peak}{unit} Â· MÃ­n: {low}{unit}",
            "chart_forecast_line": "ProyecciÃ³n: {value}{unit} en ~2h Â· promedio de campo",
            "zone_waiting_data": "Esperando mÃ¡s datos del sensor...",
            "zone_trend_after_readings": "La tendencia aparecerÃ¡ tras algunas lecturas.",
            "zone_current_trend": "Actual {value}% humedad Â· Tendencia: {trend}",
            "zone_trend_rising": "subiendo",
            "zone_trend_drying": "secÃ¡ndose",
            "zone_trend_stable": "estable",
            "problem_first_on": "Activado",
            "problem_first_off": "Desactivado",

            // Tier 1 Status
            "status_irrigate": "RIEGA TUS CULTIVOS",
            "status_check": "REVISAR PRONTO",
            "status_good": "TODO BIEN",
            "action_irrigate": "Abre la vÃ¡lvula por {hours} horas",
            "action_check": "La humedad estÃ¡ bajando",
            "action_good": "No se requiere acciÃ³n",
            // Tier 2 Reasoning
            "why_title_irrigate": "Â¿Por quÃ© necesito regar?",
            "why_title_check": "Â¿Por quÃ© debo revisar el campo?",
            "why_title_good": "Â¿Por quÃ© estÃ¡ todo bien?",
            "reason_moisture_low": "Humedad al {moisture}% (Meta: >{critical}%)",
            "reason_drying_fast": "Tasa de secado alta ({rate}%/hr)",
            "reason_stress": "EstrÃ©s del cultivo en {hours} horas",
            "reason_optimal": "La humedad del suelo estÃ¡ en el rango Ã³ptimo",
            "reason_stable": "Condiciones estables, no se necesita acciÃ³n",
            // Zone Map
            "zone_title": "Zonas del Campo",
            "zone_active": "{count} sensores activos",
            "zone_legend_optimal": "Ã“ptimo",
            "zone_legend_warning": "Advertencia",
            "zone_legend_critical": "CrÃ­tico",
            // General
            "updated": "Actualizado: {time}",
            "confidence": "Confianza: {value}%"
        }
    },

    init: function () {
        const saved = localStorage.getItem('agriscan_lang');
        if (saved && this.strings[saved]) {
            this.lang = saved;
            console.log(`[I18n] Loaded saved language: ${saved}`);
        } else {
            console.log(`[I18n] Using default language: ${this.lang}`);
        }
        this.syncSelectors();
    },

    setLang: function (code) {
        if (this.strings[code]) {
            this.lang = code;
            localStorage.setItem('agriscan_lang', code);
            console.log(`[I18n] Language changed to: ${code}`);
            this.syncSelectors();
            return true;
        }
        console.warn(`[I18n] Unknown language code: ${code}`);
        return false;
    },

    // Sync all language selectors in the UI
    syncSelectors: function () {
        const selectors = document.querySelectorAll('#lang-select-t1, #set-lang');
        selectors.forEach(sel => {
            if (sel) sel.value = this.lang;
        });
    },

    t: function (key, params = {}) {
        let str = this.strings[this.lang][key];

        if (!str) {
            console.warn(`[I18n] Missing translation for key: "${key}" in language: ${this.lang}`);
            return key; // Return key as fallback
        }

        // Replace params {key}
        Object.keys(params).forEach(k => {
            str = str.replace(new RegExp(`\\{${k}\\}`, 'g'), params[k]);
        });

        return str;
    },

    // Get current language
    getLang: function () {
        return this.lang;
    }
};

window.I18n = I18n;
